<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Votify Admin</title>

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet" />

<style>
  :root{
    --bg:#0a0b12;
    --panel: rgba(18,20,40,.78);
    --card: rgba(12,13,25,.62);
    --line: rgba(255,255,255,.10);
    --line2: rgba(255,255,255,.14);
    --txt:#ffffff;
    --muted: rgba(255,255,255,.70);
    --muted2: rgba(255,255,255,.55);

    /* Paleta morada */
    --accent:#7c5cff;
    --accent2:#5a3fff;

    --shadow: 0 18px 60px rgba(0,0,0,.45);
    --radius: 22px;
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
    color: var(--txt);
    background:
      radial-gradient(900px 500px at 15% 10%, rgba(124,92,255,.20), transparent 60%),
      radial-gradient(900px 500px at 80% 80%, rgba(90,63,255,.16), transparent 60%),
      var(--bg);
  }

  /* Top loader */
  .topLoader{
    position:fixed; top:0; left:0;
    height:3px; width:0%;
    z-index:9999;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    box-shadow:0 6px 18px rgba(124,92,255,.35);
    transition: width .25s ease, opacity .35s ease;
  }
  .topLoader.on{ width:92%; }
  .topLoader.done{ width:100%; opacity:0; }

  .wrap{
    max-width: 1120px;
    margin: 0 auto;
    padding: 28px 18px 22px;
  }

  /* Header */
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:14px;
    margin-bottom: 16px;
  }
  .brand{
    display:flex;
    align-items:center;
    gap:12px;
    min-width: 260px;
  }
  .logo{
    width:44px;height:44px;border-radius:14px;
    display:grid;place-items:center;
    overflow:hidden;
    background: rgba(124,92,255,.16);
    border: 1px solid rgba(124,92,255,.35);
  }
  .logo img{ width:100%; height:100%; object-fit:contain; padding:7px; }
  .brandTitle{
    font-weight: 900;
    letter-spacing:.2px;
    font-size: 18px;
    line-height: 1.1;
  }
  .brandSub{
    font-size: 13px;
    color: var(--muted);
    margin-top: 4px;
  }

  .actions{
    display:flex;
    align-items:center;
    gap:10px;
  }

  .btn{
    border:none;
    border-radius: 14px;
    padding: 10px 14px;
    font-weight: 900;
    cursor:pointer;
    color:#fff;
    background: rgba(255,255,255,.08);
    border:1px solid var(--line);
    backdrop-filter: blur(10px);
  }
  .btn:hover{ filter: brightness(1.06); }
  .btnPrimary{
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border: 1px solid rgba(255,255,255,.10);
    box-shadow: 0 12px 34px rgba(124,92,255,.22);
  }
  .btnGhost{
    background: rgba(124,92,255,.12);
    border: 1px solid rgba(124,92,255,.25);
  }

  /* Layout main */
  .grid{
    display:grid;
    grid-template-columns: 1.05fr .95fr;
    gap: 14px;
  }
  @media (max-width: 980px){
    .grid{ grid-template-columns: 1fr; }
  }

  .card{
    background: linear-gradient(180deg, var(--panel), rgba(12,13,25,.55));
    border: 1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .cardHead{
    padding: 16px 16px 12px;
    border-bottom: 1px solid var(--line);
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
  }
  .cardTitle{
    font-size: 15px;
    font-weight: 900;
    letter-spacing:.2px;
    margin:0;
  }
  .cardHint{
    margin: 6px 0 0 0;
    font-size: 12px;
    color: var(--muted2);
    line-height: 1.4;
  }
  .cardBody{ padding: 16px; }

  label{ display:block; font-size: 12px; color: var(--muted); margin-bottom: 8px; }
  .input{
    width:100%;
    padding: 12px 12px;
    border-radius: 14px;
    border: 1px solid var(--line2);
    background: rgba(10,11,18,.55);
    color:#fff;
    outline:none;
    font-size: 14px;
  }
  .input:focus{
    border-color: rgba(124,92,255,.55);
    box-shadow: 0 0 0 4px rgba(124,92,255,.12);
  }

  /* Genres */
  .toolbar{
    display:flex;
    align-items:center;
    gap:10px;
    margin-top: 12px;
    margin-bottom: 12px;
    flex-wrap: wrap;
  }
  .toolbar .input{
    flex: 1;
    min-width: 220px;
  }

  .chips{
    display:flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .chip{
    display:flex;
    align-items:center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 16px;
    border: 1px solid var(--line);
    background: rgba(10,11,18,.40);
    cursor:pointer;
    user-select:none;
    transition: transform .12s ease, filter .12s ease, border-color .12s ease;
  }
  .chip:hover{ filter: brightness(1.06); border-color: rgba(124,92,255,.25); }
  .chip:active{ transform: scale(.99); }

  .chipCheck{
    width:18px;height:18px;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,.20);
    background: rgba(255,255,255,.06);
    display:grid;
    place-items:center;
    flex: 0 0 auto;
  }
  .chipCheck svg{ opacity:0; transform: scale(.85); transition: .12s ease; }
  .chip.on{
    border-color: rgba(124,92,255,.40);
    background: rgba(124,92,255,.14);
  }
  .chip.on .chipCheck{
    border-color: rgba(124,92,255,.55);
    background: rgba(124,92,255,.22);
  }
  .chip.on .chipCheck svg{
    opacity:1;
    transform: scale(1);
  }
  .chipText{
    font-weight: 800;
    letter-spacing:.2px;
    font-size: 13px;
  }

  /* Result */
  .result{
    display:none;
    margin-top: 14px;
    padding: 14px;
    border-radius: 18px;
    border: 1px solid var(--line);
    background: rgba(10,11,18,.45);
  }
  .resultRow{
    display:flex;
    gap: 14px;
    align-items:center;
    flex-wrap: wrap;
  }
  .qr{
    width: 160px;
    height: 160px;
    border-radius: 18px;
    border: 1px solid var(--line);
    background: #000;
    object-fit: cover;
  }
  .k{
    color: var(--muted);
    font-size: 12px;
    margin-top: 8px;
  }
  .link{
    color: #fff;
    font-weight: 900;
    text-decoration:none;
    word-break: break-all;
  }
  .link:hover{ text-decoration: underline; }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    border-radius: 999px;
    padding: 8px 10px;
    border: 1px solid rgba(124,92,255,.25);
    background: rgba(124,92,255,.12);
    font-size: 12px;
    font-weight: 900;
    color:#fff;
  }

  /* Footer */
  .appFooter{
    margin: 16px 0 0;
    padding: 12px 14px;
    border-radius: 14px;
    border: 1px solid var(--line);
    background: rgba(18,20,40,.35);
    color: rgba(255,255,255,.72);
    font-size: 12px;
    text-align:center;
  }
</style>
</head>

<body>
  <div id="topLoader" class="topLoader" aria-hidden="true"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <img src="/data/LOGOVOTIFY/icon.png" alt="" onerror="this.remove()">
          <div id="fallbackV" style="font-weight:900;color:var(--accent);">V</div>
        </div>
        <div>
          <div class="brandTitle">Panel Admin — Votify</div>
          <div class="brandSub">Crear salas y seleccionar géneros de tu library.js</div>
        </div>
      </div>

      <div class="actions">
        <button id="logoutBtn" class="btn btnGhost" type="button">Salir</button>
      </div>
    </div>

    <div class="grid">
      <!-- Izquierda -->
      <section class="card">
        <div class="cardHead">
          <div>
            <h2 class="cardTitle">Crear sala</h2>
            <p class="cardHint">Estos géneros son los que realmente existen en <b>src/data/library.js</b>.</p>
          </div>
          <span class="pill">✅ Library Sync</span>
        </div>

        <div class="cardBody">
          <label for="nameInput">Nombre del restaurante</label>
          <input id="nameInput" class="input" placeholder="Ej. Los Cuchos" />

          <div class="toolbar">
            <input id="genreSearch" class="input" placeholder="Buscar género…" />
            <button id="selectAllBtn" class="btn" type="button">Seleccionar todo</button>
            <button id="clearBtn" class="btn" type="button">Limpiar</button>
          </div>

          <div id="chipsBox" class="chips"></div>

          <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
            <button id="createBtn" class="btn btnPrimary" type="button">Crear sala</button>
          </div>

          <div id="resultBox" class="result"></div>
        </div>
      </section>

      <!-- Derecha -->
      <aside class="card">
        <div class="cardHead">
          <div>
            <h2 class="cardTitle">Tips</h2>
            <p class="cardHint">Si aparece “No hay canciones”, es porque el género no existe en library.js.</p>
          </div>
        </div>
        <div class="cardBody" style="color:var(--muted); font-size:13px; line-height:1.55;">
          <div style="padding:12px; border-radius:18px; border:1px solid var(--line); background:rgba(10,11,18,.35);">
            <div style="font-weight:900;color:#fff;margin-bottom:8px;">Géneros disponibles (library.js)</div>
            <div id="genresList" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
          </div>

          <footer class="appFooter">© <span id="yearNow"></span> Charly García — Votify</footer>
        </div>
      </aside>
    </div>
  </div>

<script>
  document.getElementById("yearNow").textContent = new Date().getFullYear();

  const loader = document.getElementById("topLoader");
  const resultBox = document.getElementById("resultBox");
  const chipsBox = document.getElementById("chipsBox");
  const genreSearch = document.getElementById("genreSearch");
  const genresList = document.getElementById("genresList");

  // ✅ ESTO DEBE COINCIDIR 1:1 CON src/data/library.js
  const GENRES = [
    { key: "reggaetonNuevo",     label: "Reggaetón Nuevo" },
    { key: "reggaetonAntiguo",   label: "Reggaetón Antiguo" },
    { key: "corridos",           label: "Corridos" },
    { key: "banda",              label: "Banda" },
    { key: "cumbia",             label: "Cumbia" },
    { key: "salsa",              label: "Salsa" },
    { key: "merengue",           label: "Merengue" },
    { key: "rockEnEspanol",      label: "Rock en Español" },
    { key: "rockGuatemalteco",   label: "Rock Guatemalteco" },
  ];

  // Mostrar lista en la tarjeta derecha
  GENRES.forEach(g=>{
    const pill = document.createElement("span");
    pill.className = "pill";
    pill.textContent = g.label;
    genresList.appendChild(pill);
  });

  const selected = new Set();

  function checkIcon(){
    return `
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M20 6L9 17l-5-5" stroke="white" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    `;
  }

  function renderChips(filter=""){
    const q = (filter || "").trim().toLowerCase();
    chipsBox.innerHTML = "";

    GENRES
      .filter(g => !q || g.label.toLowerCase().includes(q) || g.key.toLowerCase().includes(q))
      .forEach((g) => {
        const chip = document.createElement("div");
        chip.className = "chip" + (selected.has(g.key) ? " on" : "");
        chip.setAttribute("data-genre", g.key);
        chip.innerHTML = `
          <div class="chipCheck">${checkIcon()}</div>
          <div class="chipText">${g.label}</div>
        `;

        chip.addEventListener("click", () => {
          if (selected.has(g.key)) selected.delete(g.key);
          else selected.add(g.key);
          chip.classList.toggle("on");
        });

        chipsBox.appendChild(chip);
      });
  }

  renderChips("");

  genreSearch.addEventListener("input", (e) => {
    renderChips(e.target.value);
  });

  document.getElementById("selectAllBtn").addEventListener("click", () => {
    GENRES.forEach(g => selected.add(g.key));
    renderChips(genreSearch.value);
  });

  document.getElementById("clearBtn").addEventListener("click", () => {
    selected.clear();
    renderChips(genreSearch.value);
  });

  document.getElementById("createBtn").addEventListener("click", async () => {
    const name = (document.getElementById("nameInput").value || "").trim();
    if (!name) return alert("Escribe el nombre del restaurante");

    // ✅ Enviamos LAS LLAVES reales (key), no el label
    const genres = Array.from(selected);
    if (!genres.length) return alert("Selecciona al menos 1 género");

    loader.classList.add("on");
    try{
      const res = await fetch("/api/restaurants", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ name, genres })
      });

      const data = await res.json().catch(()=> ({}));

      loader.classList.remove("on");
      loader.classList.add("done");
      setTimeout(()=> loader.classList.remove("done"), 500);

      if (!res.ok) {
        return alert(data?.error || "Error creando sala");
      }

      // según tu respuesta actual del server (restaurantRoutes.js)
      const r = data.restaurant;
      const voteUrl = r?.urlsFull?.vote || r?.urls?.vote || "";
      const tvUrl = r?.urlsFull?.tv || r?.urls?.tv || "";
      const qr = r?.qrDataUrl || "";

      resultBox.style.display = "block";
      resultBox.innerHTML = `
        <div style="font-weight:900; font-size:14px; margin-bottom:10px;">✅ Sala creada</div>
        <div class="resultRow">
          <div style="min-width:260px;">
            <div class="k">Votar</div>
            <a class="link" href="${voteUrl}" target="_blank" rel="noreferrer">${voteUrl}</a>

            <div class="k" style="margin-top:10px;">TV</div>
            <a class="link" href="${tvUrl}" target="_blank" rel="noreferrer">${tvUrl}</a>
          </div>

          ${qr ? `<img class="qr" src="${qr}" alt="QR" />` : ""}
        </div>
      `;
    }catch(err){
      loader.classList.remove("on");
      alert("No se pudo crear la sala.");
    }
  });

  document.getElementById("logoutBtn").addEventListener("click", async () => {
    try { await fetch("/api/admin/logout", { method:"POST", headers:{ "Content-Type":"application/json" } }); } catch(_){}
    location.href = "/login.html";
  });
</script>
</body>
</html>