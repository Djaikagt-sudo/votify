<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Votify ‚Äî TV</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>

    :root{
      --bg:#0a0b12;
      --panel:#121428;
      --line:#232643;
      --txt:#fff;
      --muted:#a9b0d1;
      --accent:#7c5cff;
      --accent2:#5a3fff;
      --good:#2ee59d;
      --bad:#ff3b3b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Arial,sans-serif;
      background:radial-gradient(900px 500px at 20% 10%, #1b1e38 0%, transparent 60%),
                 radial-gradient(900px 500px at 80% 20%, #14304a 0%, transparent 55%),
                 linear-gradient(180deg, #080912, #0b0c16);
      color:var(--txt);
    }
    .topbar{
      padding:18px 22px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .leftTop{display:flex;flex-direction:column;gap:8px}
    .title{font-size:22px;font-weight:800;letter-spacing:.2px}
    .pills{display:flex;gap:10px;flex-wrap:wrap}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:rgba(255,255,255,.88);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:var(--bad);box-shadow:0 0 0 4px rgba(255,59,59,.12)}
    .dot.ok{background:var(--good);box-shadow:0 0 0 4px rgba(46,229,157,.12)}

    .layout{
      display:flex;
      gap:18px;
      padding:0 18px 18px 18px;
      height: calc(100vh - 86px);
      align-items: stretch;
    }
    .layout > .card:first-child{ flex: 2; min-width: 0; }
    .layout > .card:last-child{ flex: 1; min-width: 320px; }

    .card{
      background:linear-gradient(180deg, rgba(18,20,40,.9), rgba(12,13,25,.65));
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 18px 60px rgba(0,0,0,.35);
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .cardHead{
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .cardHead h2{
      margin:0;
      font-size:14px;
      font-weight:800;
      letter-spacing:.2px;
      color:rgba(255,255,255,.92);
    }
    .sub{
      font-size:12px;
      color:rgba(255,255,255,.65);
    }

    .playerWrap{
      position:relative;
      flex:1;
      min-height:0;
      background:#000;
    }
    #player{
      position:absolute;
      inset:0;
    }

    .qrTop{
      display:flex;
      gap:14px;
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      align-items:center;
    }
    #qrImg{
      width:110px;height:110px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:#000;
    }
    .qrText{min-width:0}
    .qrTitle{font-weight:800}
    .qrLink{
      margin-top:6px;
      font-size:12px;
      color:rgba(255,255,255,.70);
      word-break:break-all;
    }

    .rankBody{
      padding:12px 12px 14px;
      overflow:auto;
      flex:1;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(10,11,18,.35);
      margin-bottom:10px;
    }
    .leftRow{display:flex;gap:10px;align-items:center;min-width:0}
    .pos{
      width:28px;height:28px;border-radius:10px;
      display:grid;place-items:center;
      font-weight:800;font-size:12px;
      background:rgba(124,92,255,.20);
      border:1px solid rgba(124,92,255,.35);
      color:#fff;
      flex:0 0 auto;
    }
    .song{min-width:0;display:flex;flex-direction:column;gap:2px}
    .song b{font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .song span{font-size:12px;color:rgba(255,255,255,.65);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .votes{
      font-weight:800;
      font-size:12px;
      color:#fff;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:7px 10px;
      border-radius:999px;
      flex:0 0 auto;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(18,20,40,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:10px 12px;
      color:#fff;
      font-size:13px;
      display:none;
      z-index:999;
      box-shadow:0 16px 60px rgba(0,0,0,.35);
    }

    /* Bot√≥n peque√±o para ‚Äúactivar sonido‚Äù */
    .soundCorner{
      position:absolute;
      top:12px;
      right:12px;
      z-index:60;
      border:none;
      border-radius:12px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
      color:#fff;
      background: rgba(124,92,255,.92);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(10px);
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .soundCorner:hover{ filter: brightness(1.05); }

    /* responsive */
    @media (max-width: 760px){
      .layout{flex-direction:column; height:auto;}
      .layout > .card:last-child{min-width:0}
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="leftTop">
      <div class="title" id="nowTitle">Votify ‚Äî TV</div>
      <div class="pills">
        <div class="pill" id="roomPill">Sala: ‚Äî</div>
        <div class="pill"><span>Modo: no repetir</span></div>
        <div class="pill" id="statusPill"><span class="dot" id="dot"></span><span id="statusText">Conectando‚Ä¶</span></div>
      </div>
    </div>
    <div class="pill">Siempre suena</div>
  </div>

  <div class="layout">
    <!-- IZQUIERDA: VIDEO -->
    <div class="card">
      <div class="cardHead">
        <h2>Reproducci√≥n</h2>
        <div class="sub" id="playerSub">Auto-skip bloqueados ‚Ä¢ Sonido activo</div>
      </div>

      <div class="playerWrap">
        <div id="player"></div>
        <button class="soundCorner" id="soundBtn" style="display:none">üîä Activar sonido</button>
      </div>
    </div>

    <!-- DERECHA: VOTOS + QR -->
    <div class="card">
      <div class="cardHead">
        <h2>Top de votos</h2>
        <div class="sub">En vivo</div>
      </div>

      <div class="qrTop">
        <img id="qrImg" alt="QR Votify">
        <div class="qrText">
          <div class="qrTitle">üì≤ Escanea para votar</div>
          <div class="qrLink" id="qrLinkText"></div>
          <div class="qrLink" id="missingHint" style="margin-top:8px; display:none;">
            Si te sale ‚ÄúRestaurante no existe‚Äù, crea una sala NUEVA en <b>/admin</b>.
          </div>
        </div>
      </div>

      <div class="rankBody" id="ranking"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const room = (location.pathname.split("/tv/")[1] || "").split("/")[0];
    const origin = location.origin;
    const voteUrl = `${origin}/r/${room}`;

    document.getElementById("roomPill").textContent = `Sala: ${room || "‚Äî"}`;
    document.getElementById("qrLinkText").textContent = voteUrl;

    (function renderQr(){
      const img = document.getElementById("qrImg");
      if (window.QRCode){
        img.src = "";
        // fallback, se llenar√° con ruta si la ten√©s
      }
      // Si tu backend ya te genera PNG, pod√©s setearlo en loadState si lo devolv√©s.
      // Mientras: usa el texto para que el usuario copie el link, y el QR del admin.
      img.src = `${origin}/qrcodes/${room}.png`; // si no existe, no pasa nada
      img.onerror = () => {
        // no rompas la UI si no existe
        img.style.opacity = "0.25";
      };
    })();

    // Estado
    let currentSongs = [];
    let playedSet = new Set();
    let lastPlayedId = null;

    // Player
    let player = null;

    // anti loops
    let __skipLock = false;
    let __resetOnNext = false;
    let __consecutiveFails = 0;
    const MAX_CONSECUTIVE_FAILS = 6;

    // Socket
    const socket = io(origin, { transports:["websocket","polling"] });
    socket.on("connect", () => {
      document.getElementById("dot").classList.add("ok");
      document.getElementById("statusText").textContent = "Conectado ‚úÖ";
      socket.emit("room:join", { room });
    });
    socket.on("disconnect", () => {
      document.getElementById("dot").classList.remove("ok");
      document.getElementById("statusText").textContent = "Desconectado‚Ä¶";
    });

    function isValidYouTubeId(id){
      return typeof id === "string" && /^[a-zA-Z0-9_-]{11}$/.test(id.trim());
    }

    function skipToNext(reason){
      if(__skipLock) return;
      __skipLock = true;
      console.log("‚è≠Ô∏è skip:", reason);

      setTimeout(async () => {
        __skipLock = false;
        __consecutiveFails++;

        if(__consecutiveFails >= MAX_CONSECUTIVE_FAILS){
          __consecutiveFails = 0;
          showToast("‚ö†Ô∏è Muchos videos bloqueados/no disponibles. Revisa youtubeId.");
        }

        const next = pickNextSong();
        if(!next) return;

        // Si el error fue embed-blocked, reiniciamos el player antes de cargar el siguiente
        if(__resetOnNext){
          __resetOnNext = false;
          try{ player?.destroy?.(); }catch(_){}
          player = null;
          await createPlayer();
        }

        playSong(next);
      }, 650);
    }

    async function loadState(){
      const res = await fetch(`/api/r/${room}/state`);
      const data = await res.json();

      if(!res.ok || data.ok === false){
        document.getElementById("missingHint").style.display = "block";
        document.getElementById("ranking").innerHTML = `
          <div style="padding:12px;color:#fff">
            ‚ùå ${data?.error || "Restaurante no existe"}<br>
            <span style="color:rgba(255,255,255,.65)">Crea una sala NUEVA en /admin.</span>
          </div>
        `;
        return;
      }

      currentSongs = Array.isArray(data.songs) ? data.songs : [];
      renderRanking(currentSongs);
    }

    function renderRanking(songs){
      const container = document.getElementById("ranking");
      if(!songs.length){
        container.innerHTML = `<div style="padding:12px;color:rgba(255,255,255,.7)">Sin canciones.</div>`;
        return;
      }

      const sorted = [...songs].sort((a,b)=> (b.votes||0) - (a.votes||0));
      container.innerHTML = sorted.slice(0, 10).map((s, idx)=>`
        <div class="row">
          <div class="leftRow">
            <div class="pos">${idx+1}</div>
            <div class="song">
              <b>${escapeHtml(s.title || "‚Äî")}</b>
              <span>${escapeHtml(s.artist || "")}</span>
            </div>
          </div>
          <div class="votes">${(s.votes||0)} votos</div>
        </div>
      `).join("");
    }

    function pickNextSong(){
      if(!currentSongs.length) return null;

      // Orden por votos desc
      const sorted = [...currentSongs].sort((a,b)=> (b.votes||0)-(a.votes||0));

      // si "no repetir", evita repetidas hasta agotar
      for(const s of sorted){
        if(!playedSet.has(s.id)) return s;
      }
      // si ya se tocaron todas, reinicia set y vuelve a empezar
      playedSet.clear();
      return sorted[0];
    }

    function playSong(song){
      if(!song || !isValidYouTubeId(song.youtubeId)) return skipToNext("invalid-id");

      lastPlayedId = song.id;
      playedSet.add(song.id);

      document.getElementById("nowTitle").textContent = `${song.title} ‚Äî ${song.artist || ""}`;

      // carga en player
      if(player && player.loadVideoById){
        try{
          player.loadVideoById(song.youtubeId);
        }catch(_){
          skipToNext("loadVideoById-failed");
        }
      }

      // avisa a clientes para sincronizaci√≥n (opcional)
      const startedAt = Date.now();
      socket.emit("song:start", { room, songId: song.id, startedAt, durationSec: 0 });
    }

    // SOCKET: cuando votan, actualiza ranking en vivo
    socket.on("votes:update", ({ room: r, songs }) => {
      if(r !== room) return;
      if(Array.isArray(songs)){
        currentSongs = songs;
        renderRanking(currentSongs);
      }
    });

    // Si termina canci√≥n => siguiente
    function onPlayerStateChange(e){
      if(e.data === YT.PlayerState.PLAYING){
        __consecutiveFails = 0;
      }

      if(e.data === YT.PlayerState.ENDED){
        socket.emit("song:ended", { room, songId: lastPlayedId });
        const next = pickNextSong();
        if(next) playSong(next);
      }

      // autoplay bloqueado / se queda UNSTARTED => bot√≥n + si se atasca, skip
      if(e.data === YT.PlayerState.UNSTARTED){
        setTimeout(checkSoundBlocked, 600);
        setTimeout(() => {
          try{
            const st = player?.getPlayerState?.();
            if(st === YT.PlayerState.UNSTARTED){
              skipToNext("unstarted-stuck");
            }
          }catch(_){
            skipToNext("unstarted-error");
          }
        }, 6500);
      }
    }

    function checkSoundBlocked(){
      try{
        const state = player?.getPlayerState?.();
        if(state !== YT.PlayerState.PLAYING){
          document.getElementById("soundBtn").style.display = "block";
        }
      }catch(_){}
    }

    document.getElementById("soundBtn").addEventListener("click", () => {
      document.getElementById("soundBtn").style.display = "none";
      try{
        player?.unMute?.();
        player?.playVideo?.();
      }catch(_){}
    });

    function showToast(msg){
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(showToast._tm);
      showToast._tm = setTimeout(()=> t.style.display = "none", 2500);
    }

    function loadYouTubeApi(){
      return new Promise((resolve) => {
        if(window.YT && window.YT.Player) return resolve();
        const tag = document.createElement("script");
        tag.src = "https://www.youtube.com/iframe_api";
        document.body.appendChild(tag);
        window.onYouTubeIframeAPIReady = () => resolve();
      });
    }

    function createPlayer(){
      return new Promise((resolve) => {
        player = new YT.Player("player", {
          height: "100%",
          width: "100%",
          playerVars: {
            autoplay: 1,
            controls: 0,
            rel: 0,
            modestbranding: 1,
            playsinline: 1,
            origin: window.location.origin
          },
          events: {
            onReady: () => resolve(),
            onStateChange: onPlayerStateChange,
            onError: (ev) => {
              const code = ev?.data;
              // 2=invalid, 5=html5, 100=not found, 101/150=embed blocked
              if(code === 101 || code === 150){
                __resetOnNext = true;
              }
              skipToNext(`yt-error:${code}`);
            }
          }
        });
      });
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    (async function init(){
      if(!room){
        document.getElementById("ranking").innerHTML = `<div style="padding:12px;color:#fff">Sala inv√°lida</div>`;
        return;
      }

      await loadState();
      await loadYouTubeApi();
      await createPlayer();

      const first = pickNextSong();
      if(first) playSong(first);
      else showToast("‚ö†Ô∏è No hay canciones con youtubeId v√°lido en esta sala.");
    })();
  </script>

  <!-- socket.io (si ya lo cargas en otro lugar, dejalo como est√° en tu proyecto) -->
  <script src="/socket.io/socket.io.js"></script>

</body>
</html>